<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test - Language Arts Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .status-box { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Authentication Flow Test</h1>
        <p>This page tests the complete login flow and module access for the Language Arts Agent</p>

        <!-- Authentication Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Authentication Status</h5>
            </div>
            <div class="card-body">
                <div id="authStatus" class="status-box info">Checking authentication...</div>
                <button class="btn btn-primary" onclick="checkAuthStatus()">Check Status</button>
                <button class="btn btn-success" onclick="autoLogin()">Auto Login (demo_student)</button>
                <button class="btn btn-warning" onclick="clearAuth()">Clear Auth</button>
            </div>
        </div>

        <!-- Manual Login -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Manual Login</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" id="username" class="form-control mb-2" placeholder="Username" value="demo_student">
                    </div>
                    <div class="col-md-6">
                        <input type="password" id="password" class="form-control mb-2" placeholder="Password" value="password123">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="manualLogin()">Login</button>
                <div id="loginResult"></div>
            </div>
        </div>

        <!-- Module Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Module API Tests</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="testWritingAPI()">Test Writing API</button>
                <button class="btn btn-info" onclick="testListeningAPI()">Test Listening API</button>
                <button class="btn btn-info" onclick="testReadingAPI()">Test Reading API</button>
                <div id="apiResults"></div>
            </div>
        </div>

        <!-- Module Links -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Module Access</h5>
            </div>
            <div class="card-body">
                <p>Once logged in, these should work:</p>
                <a href="/writing" class="btn btn-outline-warning" target="_blank">üìù Writing Module</a>
                <a href="/listening" class="btn btn-outline-info" target="_blank">üéß Listening Module</a>
                <a href="/reading" class="btn btn-outline-primary" target="_blank">üìö Reading Module</a>
                <a href="/conversation" class="btn btn-outline-success" target="_blank">üí¨ Conversation Module</a>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="card">
            <div class="card-header">
                <h5>Debug Information</h5>
            </div>
            <div class="card-body">
                <div id="debugInfo">
                    <p><strong>Current localStorage contents:</strong></p>
                    <pre id="localStorageContents">Loading...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Base URL
        const API_BASE = 'http://127.0.0.1:5001';

        // Check authentication status
        function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            const username = localStorage.getItem('username');
            const userId = localStorage.getItem('user_id');

            const statusEl = document.getElementById('authStatus');

            if (token && username) {
                statusEl.className = 'status-box success';
                statusEl.innerHTML = `
                    ‚úÖ <strong>Authenticated</strong><br>
                    Username: ${username}<br>
                    User ID: ${userId}<br>
                    Token: ${token.substring(0, 50)}...
                `;
            } else {
                statusEl.className = 'status-box error';
                statusEl.innerHTML = `
                    ‚ùå <strong>Not Authenticated</strong><br>
                    No valid token found in localStorage.<br>
                    Please login to access the modules.
                `;
            }

            updateLocalStorageDisplay();
        }

        // Auto login with demo credentials
        async function autoLogin() {
            document.getElementById('username').value = 'demo_student';
            document.getElementById('password').value = 'password123';
            await manualLogin();
        }

        // Manual login
        async function manualLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultEl = document.getElementById('loginResult');

            if (!username || !password) {
                resultEl.innerHTML = '<div class="status-box error">Please enter username and password</div>';
                return;
            }

            try {
                resultEl.innerHTML = '<div class="status-box info">Logging in...</div>';

                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    // Store authentication data
                    localStorage.setItem('auth_token', data.access_token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('user_type', data.user_type);

                    resultEl.innerHTML = `
                        <div class="status-box success">
                            ‚úÖ <strong>Login Successful!</strong><br>
                            Welcome, ${data.username}!<br>
                            You can now access all modules.
                        </div>
                    `;

                    // Update status
                    checkAuthStatus();
                } else {
                    resultEl.innerHTML = `
                        <div class="status-box error">
                            ‚ùå <strong>Login Failed:</strong> ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>Login Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Clear authentication
        function clearAuth() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_type');

            checkAuthStatus();
            document.getElementById('loginResult').innerHTML = '<div class="status-box warning">Authentication cleared</div>';
        }

        // Test Writing API
        async function testWritingAPI() {
            await testAPI('/api/writing/topics', 'Writing API');
        }

        // Test Listening API
        async function testListeningAPI() {
            await testAPI('/api/listening/topics', 'Listening API');
        }

        // Test Reading API
        async function testReadingAPI() {
            await testAPI('/api/reading/materials', 'Reading API');
        }

        // Generic API test function
        async function testAPI(endpoint, moduleName) {
            const token = localStorage.getItem('auth_token');
            const resultEl = document.getElementById('apiResults');

            if (!token) {
                resultEl.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>${moduleName} Test Failed:</strong> No authentication token found. Please login first.
                    </div>
                `;
                return;
            }

            try {
                resultEl.innerHTML = `<div class="status-box info">Testing ${moduleName}...</div>`;

                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    resultEl.innerHTML = `
                        <div class="status-box success">
                            ‚úÖ <strong>${moduleName} Test Successful!</strong><br>
                            API is working correctly. Response preview:<br>
                            <pre>${JSON.stringify(data, null, 2).substring(0, 300)}...</pre>
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="status-box error">
                            ‚ùå <strong>${moduleName} Test Failed:</strong><br>
                            Status: ${response.status}<br>
                            Error: ${data.error || 'Unknown error'}
                        </div>
                    `;
                }
            } catch (error) {
                resultEl.innerHTML = `
                    <div class="status-box error">
                        ‚ùå <strong>${moduleName} Test Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Update localStorage display
        function updateLocalStorageDisplay() {
            const contents = {
                auth_token: localStorage.getItem('auth_token'),
                username: localStorage.getItem('username'),
                user_id: localStorage.getItem('user_id'),
                user_type: localStorage.getItem('user_type')
            };

            document.getElementById('localStorageContents').textContent = JSON.stringify(contents, null, 2);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
        });
    </script>
</body>
</html>