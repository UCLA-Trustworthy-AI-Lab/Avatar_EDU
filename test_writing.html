<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Module Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #0056b3; }
        .analysis-result { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .tab { display: inline-block; background: #e9ecef; padding: 8px 16px; margin: 5px; cursor: pointer; border-radius: 3px; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; padding: 15px; border: 1px solid #ddd; margin-top: 10px; }
        .tab-content.active { display: block; }
        .score { font-size: 1.5em; font-weight: bold; color: #007bff; }
        .error { color: red; padding: 10px; background: #fff5f5; border: 1px solid #f5c6cb; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Writing Module Test</h1>

        <!-- Login Section -->
        <div id="loginSection">
            <h3>Login First</h3>
            <input type="text" id="username" placeholder="Username" value="demo_student">
            <input type="password" id="password" placeholder="Password" value="password123">
            <button onclick="login()">Login</button>
            <div id="loginResult"></div>
        </div>

        <!-- Writing Section -->
        <div id="writingSection" style="display: none;">
            <h3>Test Writing Analysis</h3>
            <textarea id="writingText" placeholder="Write your text here...">This is a test essay about the importance of education. Education is very important for everyone. It helps people learn new things and develop skills. Good education leads to better opportunities in life. Students should study hard to achieve their goals. Teachers play a crucial role in helping students succeed. Education also promotes critical thinking and problem-solving abilities. In conclusion, education is the foundation of a successful society.</textarea>

            <br>
            <button onclick="analyzeWriting()">Analyze Writing</button>
            <button onclick="clearResults()">Clear Results</button>

            <div id="loadingIndicator" style="display: none;">
                <p>Analyzing your writing...</p>
            </div>

            <div id="errorMessage"></div>

            <div id="analysisResult" style="display: none;">
                <h3>Analysis Results</h3>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="showTab('overview')">Overview</div>
                    <div class="tab" onclick="showTab('grammar')">Grammar</div>
                    <div class="tab" onclick="showTab('style')">Style</div>
                    <div class="tab" onclick="showTab('sentences')">Sentences</div>
                </div>

                <!-- Overview Tab -->
                <div id="overviewTab" class="tab-content active">
                    <h4>Scores</h4>
                    <p>Overall Score: <span id="overallScore" class="score">--</span>/100</p>
                    <p>Grammar Score: <span id="grammarScore" class="score">--</span>/100</p>
                    <p>Style Score: <span id="styleScore" class="score">--</span>/100</p>
                    <p>Clarity Score: <span id="clarityScore" class="score">--</span>/100</p>

                    <h4>Overall Feedback</h4>
                    <div id="overallFeedback" class="analysis-result">Loading...</div>
                </div>

                <!-- Grammar Tab -->
                <div id="grammarTab" class="tab-content">
                    <h4>Grammar Issues</h4>
                    <div id="grammarIssues" class="analysis-result">Loading...</div>
                </div>

                <!-- Style Tab -->
                <div id="styleTab" class="tab-content">
                    <h4>Style Suggestions</h4>
                    <div id="styleSuggestions" class="analysis-result">Loading...</div>
                </div>

                <!-- Sentences Tab -->
                <div id="sentencesTab" class="tab-content">
                    <h4>Sentence Analysis</h4>
                    <div id="sentenceAnalysis" class="analysis-result">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Raw Data Debug -->
        <div id="debugSection" style="display: none; margin-top: 30px;">
            <h3>Debug Information</h3>
            <pre id="rawResponse" style="background: #f8f9fa; padding: 15px; border: 1px solid #ddd; overflow-x: auto;"></pre>
        </div>
    </div>

    <script>
        let authToken = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');

            try {
                const response = await fetch('http://127.0.0.1:5001/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    authToken = data.access_token;
                    resultDiv.innerHTML = `<p style="color: green;">Login successful! User: ${data.username}</p>`;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('writingSection').style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">Login failed: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">Login error: ${error.message}</p>`;
            }
        }

        async function analyzeWriting() {
            const text = document.getElementById('writingText').value.trim();
            const errorDiv = document.getElementById('errorMessage');
            const loadingDiv = document.getElementById('loadingIndicator');
            const resultDiv = document.getElementById('analysisResult');
            const debugDiv = document.getElementById('debugSection');

            // Clear previous results
            errorDiv.innerHTML = '';
            resultDiv.style.display = 'none';
            debugDiv.style.display = 'none';

            if (!text) {
                errorDiv.innerHTML = '<div class="error">Please enter some text to analyze.</div>';
                return;
            }

            if (!authToken) {
                errorDiv.innerHTML = '<div class="error">Please login first.</div>';
                return;
            }

            if (text.split(/\s+/).length < 50) {
                errorDiv.innerHTML = '<div class="error">Please write at least 50 words for meaningful analysis.</div>';
                return;
            }

            try {
                loadingDiv.style.display = 'block';

                const response = await fetch('http://127.0.0.1:5001/api/writing/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({
                        text: text,
                        topic: 'test',
                        prompt: 'Test writing analysis'
                    })
                });

                const data = await response.json();

                // Show debug info
                debugDiv.style.display = 'block';
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);

                if (response.ok && data.success) {
                    displayAnalysis(data);
                    resultDiv.style.display = 'block';
                } else {
                    errorDiv.innerHTML = `<div class="error">Analysis failed: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                errorDiv.innerHTML = `<div class="error">Analysis error: ${error.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayAnalysis(response) {
            const analysis = response.analysis || response;

            // Update scores
            document.getElementById('overallScore').textContent = Math.round(analysis.overall_score || 0);
            document.getElementById('grammarScore').textContent = Math.round(analysis.grammar_accuracy || 85);
            document.getElementById('styleScore').textContent = Math.round(calculateStyleScore(analysis));
            document.getElementById('clarityScore').textContent = Math.round(calculateClarityScore(analysis));

            // Overall feedback
            const overallHtml = `
                <p><strong>Overall Feedback:</strong> ${analysis.overall_feedback || 'Your writing shows good structure.'}</p>
                <p><strong>Strengths:</strong></p>
                <ul>${(analysis.strengths || []).map(s => `<li>${s}</li>`).join('')}</ul>
                <p><strong>Areas for Improvement:</strong></p>
                <ul>${(analysis.areas_for_improvement || []).map(a => `<li>${a}</li>`).join('')}</ul>
            `;
            document.getElementById('overallFeedback').innerHTML = overallHtml;

            // Grammar issues
            const grammarHtml = (analysis.grammar_issues || []).map(issue => `
                <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #f5c6cb; background: #fff5f5; border-radius: 3px;">
                    <strong>${issue.issue || 'Grammar Issue'}</strong><br>
                    <strong>Sentence:</strong> "${issue.sentence || 'N/A'}"<br>
                    <strong>Correction:</strong> "${issue.correction || 'N/A'}"<br>
                    <strong>Explanation:</strong> ${issue.explanation || 'Grammar correction needed'}
                </div>
            `).join('') || '<p style="color: green;">No grammar issues found!</p>';
            document.getElementById('grammarIssues').innerHTML = grammarHtml;

            // Style suggestions
            const styleHtml = (analysis.style_suggestions || []).map(suggestion => `
                <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ffeaa7; background: #fffbeb; border-radius: 3px;">
                    <strong>${suggestion.suggestion || 'Style Suggestion'}</strong><br>
                    ${suggestion.example || suggestion.description || 'Consider improving this aspect of your writing style.'}<br>
                    <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">
                        ${suggestion.priority || 'medium'} priority
                    </span>
                </div>
            `).join('') || '<p style="color: green;">Your writing style is clear and appropriate!</p>';
            document.getElementById('styleSuggestions').innerHTML = styleHtml;

            // Sentence analysis
            const sentenceHtml = (analysis.sentence_analysis || []).map((sentence, index) => `
                <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 3px;">
                    <strong>Sentence ${index + 1}:</strong> "${sentence.sentence || sentence.text || 'N/A'}"<br>
                    <strong>Score:</strong> ${sentence.score || 'N/A'}/10<br>
                    <strong>Issues:</strong> ${(sentence.issues || []).join(', ') || 'No issues found'}<br>
                    ${(sentence.alternatives || []).length > 0 ? `
                        <strong>Alternatives:</strong>
                        <ul>${sentence.alternatives.map(alt => `<li>${alt}</li>`).join('')}</ul>
                    ` : ''}
                </div>
            `).join('') || '<p>Sentence-by-sentence analysis will appear here.</p>';
            document.getElementById('sentenceAnalysis').innerHTML = sentenceHtml;
        }

        function calculateStyleScore(analysis) {
            const vocabulary = analysis.vocabulary_assessment?.complexity_level;
            let score = 75;
            if (vocabulary === 'advanced') score = 90;
            else if (vocabulary === 'intermediate') score = 80;
            else if (vocabulary === 'basic') score = 70;
            return score;
        }

        function calculateClarityScore(analysis) {
            const content = analysis.content_feedback || {};
            let score = 75;
            if (content.thesis_clarity === 'clear') score += 10;
            if (content.organization === 'logical') score += 5;
            if (content.argument_strength === 'good') score += 5;
            return Math.min(score, 100);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function clearResults() {
            document.getElementById('analysisResult').style.display = 'none';
            document.getElementById('debugSection').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = '';
        }
    </script>
</body>
</html>