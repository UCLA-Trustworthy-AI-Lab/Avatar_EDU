<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Practice - Language Arts Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669;
            --secondary-color: #10b981;
            --accent-color: #34d399;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        body {
            background: linear-gradient(135deg, #065f46 0%, #059669 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .topic-selector {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .topic-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #d1fae5;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.2);
        }

        .topic-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .topic-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .topic-card.selected .topic-icon {
            color: white;
        }

        .writing-area {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .prompt-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 5px solid var(--info-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .writing-stats {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 5px;
        }

        .writing-editor {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 25px;
            min-height: 500px;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .writing-editor:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .analysis-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .analysis-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .analysis-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #d1fae5;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .score-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .feedback-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .feedback-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--info-color);
            background: white;
        }

        .feedback-item.error {
            border-left-color: var(--danger-color);
            background: #fef2f2;
        }

        .feedback-item.suggestion {
            border-left-color: var(--warning-color);
            background: #fffbeb;
        }

        .feedback-item.positive {
            border-left-color: var(--primary-color);
            background: #f0fdf4;
        }

        .sentence-analysis {
            margin-bottom: 20px;
        }

        .sentence-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .sentence-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .sentence-suggestions {
            font-size: 14px;
            color: #64748b;
        }

        .suggestion-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .tag-grammar {
            background: #fef2f2;
            color: #dc2626;
        }

        .tag-style {
            background: #fffbeb;
            color: #d97706;
        }

        .tag-vocabulary {
            background: #f0f9ff;
            color: #2563eb;
        }

        .hide {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <h1><i class="bi bi-pencil-square"></i> Writing Practice</h1>
            <p class="lead">Improve your writing skills with AI-powered analysis and feedback</p>
        </div>

        <!-- Topic Selection -->
        <div id="topicSelector" class="topic-selector">
            <h3><i class="bi bi-list-ul"></i> Choose a Writing Topic</h3>
            <div class="topic-grid">
                <div class="topic-card" onclick="handleTopicClick('argumentative')">
                    <div class="topic-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h5>Argumentative Essay</h5>
                    <p>Present and defend your position on controversial topics</p>
                </div>
                <div class="topic-card" onclick="handleTopicClick('descriptive')">
                    <div class="topic-icon">
                        <i class="bi bi-image"></i>
                    </div>
                    <h5>Descriptive Writing</h5>
                    <p>Paint vivid pictures with detailed descriptions</p>
                </div>
                <div class="topic-card" onclick="handleTopicClick('narrative')">
                    <div class="topic-icon">
                        <i class="bi bi-book"></i>
                    </div>
                    <h5>Narrative Essay</h5>
                    <p>Tell compelling stories with clear structure</p>
                </div>
                <div class="topic-card" onclick="handleTopicClick('analytical')">
                    <div class="topic-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h5>Analytical Writing</h5>
                    <p>Analyze texts, data, or complex concepts</p>
                </div>
                <div class="topic-card" onclick="handleTopicClick('academic')">
                    <div class="topic-icon">
                        <i class="bi bi-mortarboard"></i>
                    </div>
                    <h5>Academic Writing</h5>
                    <p>Formal academic papers and research writing</p>
                </div>
                <div class="topic-card" onclick="handleTopicClick('business')">
                    <div class="topic-icon">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <h5>Business Writing</h5>
                    <p>Professional emails, reports, and proposals</p>
                </div>
            </div>
        </div>

        <!-- Writing Area -->
        <div id="writingArea" class="writing-area hide">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 id="topicTitle"><i class="bi bi-pencil-square"></i> Writing Task</h3>
                <button class="btn btn-outline-secondary" onclick="window.writingPractice && writingPractice.backToTopics()">
                    <i class="bi bi-arrow-left"></i> Change Topic
                </button>
            </div>

            <!-- Writing Prompt -->
            <div class="prompt-section">
                <h5><i class="bi bi-lightbulb"></i> Writing Prompt</h5>
                <p id="writingPrompt" class="mb-0">Loading prompt...</p>
            </div>

            <!-- Writing Stats -->
            <div class="writing-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div id="wordCount" class="stat-number">0</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-item">
                        <div id="charCount" class="stat-number">0</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-item">
                        <div id="sentenceCount" class="stat-number">0</div>
                        <div class="stat-label">Sentences</div>
                    </div>
                    <div class="stat-item">
                        <div id="paragraphCount" class="stat-number">0</div>
                        <div class="stat-label">Paragraphs</div>
                    </div>
                    <div class="stat-item">
                        <div id="readingTime" class="stat-number">0m</div>
                        <div class="stat-label">Reading Time</div>
                    </div>
                </div>
            </div>

            <!-- Writing Editor -->
            <textarea id="writingEditor" class="writing-editor"
                placeholder="Start writing here... Express your thoughts clearly and organize your ideas logically."
                oninput="writingPractice.updateStats()"></textarea>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="analyzeBtn" class="btn btn-primary btn-lg" onclick="window.writingPractice && writingPractice.analyzeWriting()">
                    <i class="bi bi-search"></i> Analyze My Writing
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="window.writingPractice && writingPractice.clearEditor()">
                    <i class="bi bi-arrow-clockwise"></i> Clear
                </button>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisSection" class="analysis-section hide">
            <h3><i class="bi bi-clipboard-data"></i> Writing Analysis</h3>

            <!-- Analysis Tabs -->
            <div class="analysis-tabs">
                <button class="analysis-tab active" onclick="window.writingPractice && writingPractice.showTab('overview')">
                    <i class="bi bi-speedometer2"></i> Overview
                </button>
                <button class="analysis-tab" onclick="window.writingPractice && writingPractice.showTab('grammar')">
                    <i class="bi bi-spell-check"></i> Grammar
                </button>
                <button class="analysis-tab" onclick="window.writingPractice && writingPractice.showTab('style')">
                    <i class="bi bi-palette"></i> Style
                </button>
                <button class="analysis-tab" onclick="window.writingPractice && writingPractice.showTab('sentences')">
                    <i class="bi bi-list-ol"></i> Sentences
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
                <div class="score-overview">
                    <div class="score-card">
                        <div id="overallScore" class="score-value">85</div>
                        <div class="score-label">Overall Score</div>
                    </div>
                    <div class="score-card">
                        <div id="grammarScore" class="score-value">92</div>
                        <div class="score-label">Grammar</div>
                    </div>
                    <div class="score-card">
                        <div id="styleScore" class="score-value">78</div>
                        <div class="score-label">Style</div>
                    </div>
                    <div class="score-card">
                        <div id="clarityScore" class="score-value">88</div>
                        <div class="score-label">Clarity</div>
                    </div>
                </div>

                <div class="feedback-section">
                    <h5><i class="bi bi-chat-square-text"></i> Overall Feedback</h5>
                    <div id="overallFeedback" class="feedback-item">
                        Loading analysis...
                    </div>
                </div>
            </div>

            <!-- Grammar Tab -->
            <div id="grammarTab" class="tab-content">
                <div class="feedback-section">
                    <h5><i class="bi bi-exclamation-triangle"></i> Grammar Issues</h5>
                    <div id="grammarIssues">
                        Loading grammar analysis...
                    </div>
                </div>
            </div>

            <!-- Style Tab -->
            <div id="styleTab" class="tab-content">
                <div class="feedback-section">
                    <h5><i class="bi bi-lightbulb"></i> Style Suggestions</h5>
                    <div id="styleSuggestions">
                        Loading style analysis...
                    </div>
                </div>
            </div>

            <!-- Sentences Tab -->
            <div id="sentencesTab" class="tab-content">
                <div class="sentence-analysis">
                    <h5><i class="bi bi-list-check"></i> Sentence-by-Sentence Analysis</h5>
                    <div id="sentenceAnalysis">
                        Loading sentence analysis...
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-primary me-2" onclick="window.writingPractice && writingPractice.backToWriting()">
                    <i class="bi bi-pencil"></i> Continue Writing
                </button>
                <button class="btn btn-outline-success me-2" onclick="window.writingPractice && writingPractice.newTask()">
                    <i class="bi bi-plus-circle"></i> New Writing Task
                </button>
                <button class="btn btn-outline-secondary" onclick="window.writingPractice && writingPractice.backToHome()">
                    <i class="bi bi-house"></i> Back to Home
                </button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hide">
            <div class="loading">
                <div class="spinner"></div>
                <p class="mt-3">Analyzing your writing...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global function to handle topic clicks with error handling
        function handleTopicClick(topicType) {
            console.log('handleTopicClick called with:', topicType); // DEBUG

            try {
                if (window.writingPractice && typeof window.writingPractice.selectTopic === 'function') {
                    window.writingPractice.selectTopic(topicType);
                } else {
                    console.error('WritingPractice object not found or selectTopic method missing');
                    alert('Unable to select topic. Please refresh the page and try again.');
                }
            } catch (error) {
                console.error('Error in handleTopicClick:', error);
                alert('Error selecting topic: ' + error.message);
            }
        }

        class WritingPractice {
            constructor() {
                this.currentTopic = null;
                this.currentPrompt = null;
                this.analysisData = null;
            }

            async selectTopic(topic) {
                console.log('selectTopic called with:', topic); // DEBUG
                this.currentTopic = topic;

                // Update UI - find and select the correct card
                document.querySelectorAll('.topic-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Find the card that matches this topic by looking for the onclick attribute
                const topicCards = document.querySelectorAll('.topic-card');
                for (const card of topicCards) {
                    const onclick = card.getAttribute('onclick');
                    if (onclick && onclick.includes(`'${topic}'`)) {
                        card.classList.add('selected');
                        console.log('Found and selected card for topic:', topic); // DEBUG
                        break;
                    }
                }

                console.log('Topic UI updated, making API call...'); // DEBUG

                try {
                    // Check if we have auth token
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        console.error('No auth token available'); // DEBUG
                        // Instead of showing alert, just show writing area with a default prompt
                        console.log('Showing writing area without API call (no auth)'); // DEBUG
                        this.showWritingAreaWithDefaultPrompt(topic);
                        return;
                    }

                    console.log('Auth token found, making API call to get prompt...'); // DEBUG

                    // Load writing prompt
                    const response = await fetch(`/api/writing/prompt?topic=${topic}`, {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    console.log('API response status:', response.status); // DEBUG

                    if (!response.ok) {
                        // If API fails, show writing area with default prompt instead of error
                        console.error('API failed, using default prompt'); // DEBUG
                        this.showWritingAreaWithDefaultPrompt(topic);
                        return;
                    }

                    const data = await response.json();
                    console.log('Prompt data received:', data); // DEBUG

                    if (!data.success || !data.prompt) {
                        // Use default prompt if response is invalid
                        this.showWritingAreaWithDefaultPrompt(topic);
                        return;
                    }

                    this.currentPrompt = data.prompt;

                    // Update UI
                    const titleEl = document.getElementById('topicTitle');
                    const promptEl = document.getElementById('writingPrompt');

                    const topicTitle = data.prompt.topic || topic.charAt(0).toUpperCase() + topic.slice(1);
                    const promptText = data.prompt.prompt || 'Write about ' + topic + '.';

                    if (titleEl) {
                        titleEl.innerHTML = `<i class="bi bi-pencil-square"></i> ${topicTitle} Writing`;
                    }
                    if (promptEl) {
                        promptEl.textContent = promptText;
                    }

                    console.log('UI updated with prompt, showing writing area...'); // DEBUG

                    // Show writing area immediately
                    const selectorEl = document.getElementById('topicSelector');
                    const areaEl = document.getElementById('writingArea');

                    if (selectorEl) {
                        selectorEl.classList.add('hide');
                        console.log('Topic selector hidden'); // DEBUG
                    }
                    if (areaEl) {
                        areaEl.classList.remove('hide');
                        console.log('Writing area shown'); // DEBUG
                    }

                    console.log('Writing area should now be visible!'); // DEBUG

                } catch (error) {
                    console.error('Error loading prompt:', error);
                    // Show writing area with default prompt instead of error
                    console.log('Exception caught, showing default prompt'); // DEBUG
                    this.showWritingAreaWithDefaultPrompt(topic);
                }
            }

            showWritingAreaWithDefaultPrompt(topic) {
                console.log('showWritingAreaWithDefaultPrompt called for:', topic); // DEBUG

                // Default prompts based on topic
                const defaultPrompts = {
                    'argumentative': {
                        title: 'Argumentative Essay',
                        prompt: 'Write an argumentative essay on a topic of your choice. Present a clear thesis statement and support it with logical arguments and evidence. Consider potential counterarguments and address them in your essay. Your essay should be well-organized with an introduction, body paragraphs, and a conclusion.'
                    },
                    'descriptive': {
                        title: 'Descriptive Writing',
                        prompt: 'Write a descriptive piece that brings a scene, person, or experience to life. Use vivid sensory details and figurative language to help your reader visualize and connect with your subject. Focus on creating a strong atmosphere and emotional impact.'
                    },
                    'narrative': {
                        title: 'Narrative Essay',
                        prompt: 'Write a narrative essay telling a story from your personal experience or imagination. Include compelling characters, a clear plot with conflict and resolution, and vivid details that bring your story to life. Make sure your narrative has a clear beginning, middle, and end.'
                    },
                    'analytical': {
                        title: 'Analytical Writing',
                        prompt: 'Write an analytical essay examining a text, concept, or phenomenon in depth. Break down your subject into its component parts, examine how these parts work together, and draw conclusions based on your analysis. Support your analysis with specific examples and evidence.'
                    },
                    'academic': {
                        title: 'Academic Writing',
                        prompt: 'Write an academic essay on a scholarly topic. Use formal language, cite credible sources, and follow proper academic structure. Your essay should demonstrate critical thinking, thorough research, and clear argumentation.'
                    },
                    'business': {
                        title: 'Business Writing',
                        prompt: 'Write a professional business document such as a report, proposal, or formal email. Use clear, concise language appropriate for a business context. Focus on being informative, persuasive, and action-oriented while maintaining a professional tone.'
                    }
                };

                const promptData = defaultPrompts[topic] || {
                    title: topic.charAt(0).toUpperCase() + topic.slice(1) + ' Writing',
                    prompt: `Write about ${topic}. Focus on clear structure, strong arguments, and proper grammar. Start with an introduction, develop your ideas in body paragraphs, and end with a conclusion.`
                };

                this.currentPrompt = {
                    topic: promptData.title,
                    prompt: promptData.prompt
                };

                // Update UI
                const titleEl = document.getElementById('topicTitle');
                const promptEl = document.getElementById('writingPrompt');

                if (titleEl) {
                    titleEl.innerHTML = `<i class="bi bi-pencil-square"></i> ${promptData.title}`;
                }
                if (promptEl) {
                    promptEl.textContent = promptData.prompt;
                }

                // Show writing area
                const selectorEl = document.getElementById('topicSelector');
                const areaEl = document.getElementById('writingArea');

                if (selectorEl) {
                    selectorEl.classList.add('hide');
                    console.log('Topic selector hidden'); // DEBUG
                }
                if (areaEl) {
                    areaEl.classList.remove('hide');
                    console.log('Writing area shown with default prompt'); // DEBUG
                }
            }

            updateStats() {
                const text = document.getElementById('writingEditor').value;

                const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
                const charCount = text.length;
                const sentenceCount = text.trim() ? text.split(/[.!?]+/).filter(s => s.trim()).length : 0;
                const paragraphCount = text.trim() ? text.split(/\n\s*\n/).filter(p => p.trim()).length : 0;
                const readingTime = Math.ceil(wordCount / 200); // Assume 200 words per minute

                document.getElementById('wordCount').textContent = wordCount;
                document.getElementById('charCount').textContent = charCount;
                document.getElementById('sentenceCount').textContent = sentenceCount;
                document.getElementById('paragraphCount').textContent = paragraphCount;
                document.getElementById('readingTime').textContent = `${readingTime}m`;
            }

            async analyzeWriting() {
                const text = document.getElementById('writingEditor').value.trim();

                if (!text) {
                    alert('Please write something before analyzing.');
                    return;
                }

                if (text.split(/\s+/).length < 50) {
                    alert('Please write at least 50 words for meaningful analysis.');
                    return;
                }

                try {
                    // Show loading
                    document.getElementById('loadingOverlay').classList.remove('hide');
                    document.getElementById('analyzeBtn').disabled = true;

                    console.log('Starting analysis...'); // DEBUG

                    // Check for auth token
                    const token = localStorage.getItem('auth_token');

                    if (!token) {
                        // Provide basic client-side analysis without API
                        console.log('No auth token, providing basic analysis'); // DEBUG
                        this.provideBasicAnalysis(text);
                        return;
                    }

                    // Submit for analysis
                    const response = await fetch('/api/writing/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({
                            text: text,
                            topic: this.currentTopic || 'general',
                            prompt: this.currentPrompt?.prompt || 'General writing task'
                        })
                    });

                    console.log('Response status:', response.status); // DEBUG

                    if (!response.ok) {
                        // If API fails, provide basic analysis
                        console.log('API failed, providing basic analysis'); // DEBUG
                        this.provideBasicAnalysis(text);
                        return;
                    }

                    const analysisData = await response.json();
                    console.log('Analysis data received:', analysisData); // DEBUG

                    this.analysisData = analysisData;

                    if (analysisData.success && analysisData.analysis) {
                        // Display results
                        this.displayAnalysis(analysisData);

                        // Show analysis section
                        document.getElementById('writingArea').classList.add('hide');
                        document.getElementById('analysisSection').classList.remove('hide');

                        console.log('Analysis displayed successfully'); // DEBUG
                    } else {
                        // Fallback to basic analysis
                        this.provideBasicAnalysis(text);
                    }

                } catch (error) {
                    console.error('Error analyzing writing:', error);
                    // Provide basic analysis instead of showing error
                    this.provideBasicAnalysis(text);
                } finally {
                    document.getElementById('loadingOverlay').classList.add('hide');
                    document.getElementById('analyzeBtn').disabled = false;
                }
            }

            provideBasicAnalysis(text) {
                console.log('Providing basic analysis'); // DEBUG

                // Basic text analysis
                const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
                const words = text.trim().split(/\s+/);
                const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim());

                // Basic scoring
                const wordCount = words.length;
                const avgSentenceLength = sentences.length > 0 ? Math.round(wordCount / sentences.length) : 0;
                const readabilityScore = Math.min(100, Math.max(50, 100 - Math.abs(avgSentenceLength - 15) * 2));

                const analysisData = {
                    success: true,
                    analysis: {
                        overall_score: readabilityScore,
                        word_count: wordCount,
                        readability_level: avgSentenceLength < 10 ? 'basic' : avgSentenceLength > 25 ? 'complex' : 'intermediate',
                        strengths: [
                            wordCount >= 250 ? 'Good length for an essay' : 'Consider expanding your essay',
                            paragraphs.length > 1 ? 'Good paragraph structure' : 'Consider breaking into paragraphs',
                            sentences.length > 5 ? 'Multiple sentences provide variety' : 'Add more sentences'
                        ].filter(s => !s.includes('Consider')),
                        areas_for_improvement: [
                            wordCount < 250 ? 'Expand your essay to at least 250 words' : null,
                            paragraphs.length <= 1 ? 'Break your text into multiple paragraphs' : null,
                            avgSentenceLength > 25 ? 'Some sentences may be too long' : null,
                            avgSentenceLength < 10 ? 'Try using more complex sentences' : null
                        ].filter(Boolean),
                        grammar_issues: [],
                        style_suggestions: [
                            {
                                suggestion: 'Review your grammar and spelling',
                                example: 'Use grammar checking tools for detailed feedback',
                                priority: 'high'
                            }
                        ],
                        content_feedback: {
                            thesis_clarity: 'Review needed',
                            argument_strength: 'Review needed',
                            evidence_quality: 'Review needed',
                            organization: paragraphs.length > 2 ? 'adequate' : 'needs improvement',
                            conclusion_effectiveness: 'Review needed'
                        },
                        sentence_analysis: sentences.slice(0, 3).map((sentence, idx) => ({
                            sentence: sentence.trim(),
                            issues: [],
                            alternatives: [],
                            score: 7
                        })),
                        vocabulary_assessment: {
                            complexity_level: 'intermediate',
                            advanced_words: [],
                            suggestions: ['Login to get detailed vocabulary analysis']
                        },
                        overall_feedback: `Your essay contains ${wordCount} words across ${sentences.length} sentences. ${wordCount >= 250 ? 'Good job meeting the minimum length requirement!' : 'Consider expanding your essay for better development of ideas.'} For detailed grammar and style analysis, please login to access AI-powered feedback.`
                    }
                };

                this.displayAnalysis(analysisData);

                // Show analysis section
                document.getElementById('writingArea').classList.add('hide');
                document.getElementById('analysisSection').classList.remove('hide');
                document.getElementById('loadingOverlay').classList.add('hide');
            }

            displayAnalysis(analysisResponse) {
                console.log('displayAnalysis called with:', analysisResponse); // DEBUG

                const analysis = analysisResponse.analysis || analysisResponse;
                console.log('Analysis object:', analysis); // DEBUG

                if (!analysis) {
                    console.error('No analysis data found!');
                    alert('No analysis data received. Please try again.');
                    return;
                }

                try {
                    // Update scores - derive from content_feedback and other metrics
                    const overallScore = analysis.overall_score || 75;
                    const grammarScore = analysis.grammar_accuracy || 85;
                    const styleScore = this.calculateStyleScore(analysis);
                    const clarityScore = this.calculateClarityScore(analysis);

                    console.log('Calculated scores:', { overallScore, grammarScore, styleScore, clarityScore }); // DEBUG

                    // Ensure score elements exist before updating
                    const overallEl = document.getElementById('overallScore');
                    const grammarEl = document.getElementById('grammarScore');
                    const styleEl = document.getElementById('styleScore');
                    const clarityEl = document.getElementById('clarityScore');

                    if (overallEl) overallEl.textContent = Math.round(overallScore);
                    if (grammarEl) grammarEl.textContent = Math.round(grammarScore);
                    if (styleEl) styleEl.textContent = Math.round(styleScore);
                    if (clarityEl) clarityEl.textContent = Math.round(clarityScore);

                    // Overall feedback
                    const feedbackEl = document.getElementById('overallFeedback');
                    if (feedbackEl) {
                        feedbackEl.innerHTML = `
                            <div class="feedback-item">
                                <h6><i class="bi bi-chat-square-text"></i> Overall Feedback</h6>
                                <p>${analysis.overall_feedback || 'Your writing shows good structure and clarity.'}</p>

                                <h6 class="mt-3"><i class="bi bi-star"></i> Strengths</h6>
                                <ul class="list-unstyled">
                                    ${(analysis.strengths || []).map(strength => `<li><i class="bi bi-check-circle text-success"></i> ${strength}</li>`).join('')}
                                </ul>

                                <h6 class="mt-3"><i class="bi bi-target"></i> Areas for Improvement</h6>
                                <ul class="list-unstyled">
                                    ${(analysis.areas_for_improvement || []).map(area => `<li><i class="bi bi-arrow-up-circle text-info"></i> ${area}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }

                    // Grammar issues
                    const grammarHtml = (analysis.grammar_issues || []).map(issue => `
                        <div class="feedback-item error">
                            <h6><i class="bi bi-exclamation-circle"></i> ${issue.issue || 'Grammar Issue'}</h6>
                            <p><strong>Sentence:</strong> "${issue.sentence || 'N/A'}"</p>
                            <p><strong>Correction:</strong> "${issue.correction || 'N/A'}"</p>
                            <p><strong>Explanation:</strong> ${issue.explanation || 'Grammar correction needed'}</p>
                        </div>
                    `).join('') || '<div class="alert alert-success"><i class="bi bi-check-circle"></i> No grammar issues found!</div>';

                    const grammarEl = document.getElementById('grammarIssues');
                    if (grammarEl) {
                        grammarEl.innerHTML = grammarHtml;
                    }

                    // Style suggestions
                    const styleHtml = (analysis.style_suggestions || []).map(suggestion => `
                        <div class="feedback-item suggestion">
                            <h6><i class="bi bi-lightbulb"></i> ${suggestion.suggestion || 'Style Suggestion'}</h6>
                            <p>${suggestion.example || suggestion.description || 'Consider improving this aspect of your writing style.'}</p>
                            <span class="badge bg-primary">${suggestion.priority || 'medium'} priority</span>
                        </div>
                    `).join('') || '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Your writing style is clear and appropriate!</div>';

                    const styleEl = document.getElementById('styleSuggestions');
                    if (styleEl) {
                        styleEl.innerHTML = styleHtml;
                    }

                    // Sentence analysis
                    const sentenceHtml = (analysis.sentence_analysis || []).map((sentence, index) => `
                        <div class="sentence-item mb-3 p-3 border rounded">
                            <div class="sentence-text mb-2">
                                <strong>Sentence ${index + 1}:</strong> "${sentence.sentence || sentence.text || 'N/A'}"
                            </div>
                            <div class="sentence-score mb-2">
                                <span class="badge bg-primary">Score: ${sentence.score || 'N/A'}/10</span>
                            </div>
                            <div class="sentence-suggestions">
                                <strong>Issues:</strong>
                                ${(sentence.issues || []).map(issue =>
                                    `<span class="suggestion-tag badge bg-warning ms-1">${issue}</span>`
                                ).join('') || '<span class="text-success">No issues found</span>'}
                            </div>
                            ${(sentence.alternatives || []).length > 0 ? `
                                <div class="mt-2">
                                    <strong>Alternatives:</strong>
                                    <ul class="mt-1">
                                        ${sentence.alternatives.map(alt => `<li>${alt}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') || '<div class="alert alert-info">Sentence-by-sentence analysis will appear here.</div>';

                    const sentenceEl = document.getElementById('sentenceAnalysis');
                    if (sentenceEl) {
                        sentenceEl.innerHTML = sentenceHtml;
                    }

                    console.log('All analysis content updated successfully'); // DEBUG

                } catch (displayError) {
                    console.error('Error in displayAnalysis:', displayError);
                    alert(`Error displaying analysis results: ${displayError.message}`);
                }
            }

            calculateStyleScore(analysis) {
                // Calculate style score based on available metrics
                const vocabulary = analysis.vocabulary_assessment?.complexity_level;
                let score = 75; // default

                if (vocabulary === 'advanced') score = 90;
                else if (vocabulary === 'intermediate') score = 80;
                else if (vocabulary === 'basic') score = 70;

                return score;
            }

            calculateClarityScore(analysis) {
                // Calculate clarity score from content feedback
                const content = analysis.content_feedback || {};
                let score = 75; // default

                if (content.thesis_clarity === 'clear') score += 10;
                if (content.organization === 'logical') score += 5;
                if (content.argument_strength === 'good') score += 5;

                return Math.min(score, 100);
            }

            showTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.analysis-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + 'Tab').classList.add('active');
            }

            clearEditor() {
                if (confirm('Are you sure you want to clear all your writing?')) {
                    document.getElementById('writingEditor').value = '';
                    this.updateStats();
                }
            }

            backToTopics() {
                document.getElementById('writingArea').classList.add('hide');
                document.getElementById('analysisSection').classList.add('hide');
                document.getElementById('topicSelector').classList.remove('hide');

                // Clear selected topic
                document.querySelectorAll('.topic-card').forEach(card => {
                    card.classList.remove('selected');
                });
            }

            backToWriting() {
                document.getElementById('analysisSection').classList.add('hide');
                document.getElementById('writingArea').classList.remove('hide');
            }

            newTask() {
                if (confirm('Start a new writing task? Your current work will be lost.')) {
                    document.getElementById('writingEditor').value = '';
                    this.updateStats();
                    this.backToTopics();
                }
            }

            backToHome() {
                window.location.href = '/';
            }
        }

        // Initialize the writing practice object immediately
        window.writingPractice = new WritingPractice();
        console.log('WritingPractice initialized'); // DEBUG

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Writing page loaded'); // DEBUG

            // Check authentication
            const token = localStorage.getItem('auth_token');
            console.log('Auth token check:', token ? 'found' : 'not found'); // DEBUG

            if (!token) {
                // Instead of immediate redirect, disable UI and show login message
                console.log('No token found, user needs to login'); // DEBUG

                // Disable all topic cards
                document.querySelectorAll('.topic-card').forEach(card => {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                    card.onclick = () => {
                        alert('Please login first to use the writing module.');
                        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                    };
                });

                // Show login message
                const topicSelector = document.getElementById('topicSelector');
                if (topicSelector) {
                    const loginMessage = document.createElement('div');
                    loginMessage.className = 'alert alert-warning mt-3';
                    loginMessage.innerHTML = `
                        <i class="bi bi-exclamation-triangle"></i>
                        Please <a href="/login?redirect=${encodeURIComponent(window.location.pathname)}" class="alert-link">login</a> to access the writing module.
                    `;
                    topicSelector.appendChild(loginMessage);
                }
                return;
            }

            console.log('User authenticated, ready to use writing module'); // DEBUG
        });
    </script>
</body>
</html>