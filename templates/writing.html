<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Practice - Language Arts Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #059669;
            --secondary-color: #10b981;
            --accent-color: #34d399;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        body {
            background: linear-gradient(135deg, #065f46 0%, #059669 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .topic-selector {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .topic-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #d1fae5;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .topic-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.2);
        }

        .topic-card.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .topic-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .topic-card.selected .topic-icon {
            color: white;
        }

        .writing-area {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .writing-area.active {
            display: block;
        }

        .prompt-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 5px solid var(--info-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .writing-stats {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 5px;
        }

        .writing-editor {
            width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 25px;
            min-height: 500px;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .writing-editor:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .analysis-section.active {
            display: block;
        }

        .analysis-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
            gap: 10px;
        }

        .analysis-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .analysis-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #d1fae5;
            margin-bottom: 20px;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .feedback-section {
            background: #f8fafc;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .on-topic-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .on-topic {
            background: #d1fae5;
            color: #065f46;
        }

        .off-topic {
            background: #fecaca;
            color: #991b1b;
        }

        .grammar-correction {
            background: #fef3c7;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .sentence-analysis-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sentence-number {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }

        .sentence-original {
            font-style: italic;
            color: #475569;
            margin: 15px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 5px;
        }

        .sentence-alternative {
            color: #059669;
            margin-top: 10px;
            padding: 15px;
            background: #f0fdf4;
            border-radius: 5px;
            border: 1px solid #d1fae5;
        }

        .issue-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .tag-grammar {
            background: #fef2f2;
            color: #dc2626;
        }

        .tag-clarity {
            background: #fefce8;
            color: #ca8a04;
        }

        .tag-style {
            background: #f0f9ff;
            color: #2563eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <h1><i class="bi bi-pencil-square"></i> Writing Practice</h1>
            <p class="lead">Improve your writing skills with AI-powered analysis and feedback</p>
        </div>

        <!-- Topic Selection -->
        <div id="topicSelector" class="topic-selector">
            <h3><i class="bi bi-list-ul"></i> Choose a Writing Topic</h3>
            <div class="topic-grid">
                <div class="topic-card" data-topic="argumentative">
                    <div class="topic-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h5>Argumentative Essay</h5>
                    <p>Present and defend your position on controversial topics</p>
                </div>
                <div class="topic-card" data-topic="descriptive">
                    <div class="topic-icon">
                        <i class="bi bi-image"></i>
                    </div>
                    <h5>Descriptive Writing</h5>
                    <p>Paint vivid pictures with detailed descriptions</p>
                </div>
                <div class="topic-card" data-topic="narrative">
                    <div class="topic-icon">
                        <i class="bi bi-book"></i>
                    </div>
                    <h5>Narrative Essay</h5>
                    <p>Tell compelling stories with clear structure</p>
                </div>
                <div class="topic-card" data-topic="analytical">
                    <div class="topic-icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h5>Analytical Writing</h5>
                    <p>Analyze texts, data, or complex concepts</p>
                </div>
                <div class="topic-card" data-topic="academic">
                    <div class="topic-icon">
                        <i class="bi bi-mortarboard"></i>
                    </div>
                    <h5>Academic Writing</h5>
                    <p>Formal academic papers and research writing</p>
                </div>
                <div class="topic-card" data-topic="business">
                    <div class="topic-icon">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <h5>Business Writing</h5>
                    <p>Professional emails, reports, and proposals</p>
                </div>
            </div>
        </div>

        <!-- Writing Area -->
        <div id="writingArea" class="writing-area">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 id="topicTitle"><i class="bi bi-pencil-square"></i> Writing Task</h3>
                <button class="btn btn-outline-secondary" id="backToTopicsBtn">
                    <i class="bi bi-arrow-left"></i> Change Topic
                </button>
            </div>

            <!-- Writing Prompt -->
            <div class="prompt-section">
                <h5><i class="bi bi-lightbulb"></i> Writing Prompt</h5>
                <p id="writingPrompt" class="mb-0">Select a topic to begin writing...</p>
            </div>

            <!-- Writing Stats -->
            <div class="writing-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div id="wordCount" class="stat-number">0</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-item">
                        <div id="charCount" class="stat-number">0</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-item">
                        <div id="sentenceCount" class="stat-number">0</div>
                        <div class="stat-label">Sentences</div>
                    </div>
                    <div class="stat-item">
                        <div id="paragraphCount" class="stat-number">0</div>
                        <div class="stat-label">Paragraphs</div>
                    </div>
                    <div class="stat-item">
                        <div id="readingTime" class="stat-number">0m</div>
                        <div class="stat-label">Reading Time</div>
                    </div>
                </div>
            </div>

            <!-- Writing Editor -->
            <textarea id="writingEditor" class="writing-editor"
                placeholder="Start writing here... Express your thoughts clearly and organize your ideas logically."></textarea>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="analyzeBtn" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> Analyze My Writing with AI
                </button>
                <button id="clearBtn" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-arrow-clockwise"></i> Clear
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p class="mt-3">AI is analyzing your writing... This may take a moment.</p>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisSection" class="analysis-section">
            <h3><i class="bi bi-clipboard-data"></i> AI Writing Analysis</h3>

            <!-- Analysis Tabs -->
            <div class="analysis-tabs">
                <button class="analysis-tab active" data-tab="overall">
                    <i class="bi bi-speedometer2"></i> Overall
                </button>
                <button class="analysis-tab" data-tab="grammar">
                    <i class="bi bi-spell-check"></i> Grammar
                </button>
                <button class="analysis-tab" data-tab="style">
                    <i class="bi bi-palette"></i> Style
                </button>
                <button class="analysis-tab" data-tab="sentences">
                    <i class="bi bi-list-ol"></i> Sentence Analysis
                </button>
            </div>

            <!-- Overall Tab -->
            <div id="overallTab" class="tab-content active">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="score-card">
                            <div id="overallScore" class="score-value">--</div>
                            <div>Overall Score</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="score-card">
                            <div id="grammarScore" class="score-value">--</div>
                            <div>Grammar</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="score-card">
                            <div id="styleScore" class="score-value">--</div>
                            <div>Style</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="score-card">
                            <div id="topicRelevance" class="on-topic-badge">
                                Checking...
                            </div>
                            <div>Topic Relevance</div>
                        </div>
                    </div>
                </div>

                <div class="feedback-section">
                    <h5><i class="bi bi-file-text"></i> Essay Summary</h5>
                    <div id="essaySummary" class="mb-3">
                        <p>Loading summary...</p>
                    </div>

                    <h5><i class="bi bi-list-check"></i> Main Points</h5>
                    <ul id="mainPoints">
                        <li>Loading...</li>
                    </ul>

                    <h5><i class="bi bi-lightbulb"></i> Thesis Statement</h5>
                    <div id="thesisStatement" class="alert-info">
                        Identifying thesis...
                    </div>

                    <h5><i class="bi bi-arrow-up-circle"></i> Top Recommendations</h5>
                    <ol id="recommendations">
                        <li>Loading recommendations...</li>
                    </ol>
                </div>
            </div>

            <!-- Grammar Tab -->
            <div id="grammarTab" class="tab-content">
                <div class="feedback-section">
                    <h5><i class="bi bi-exclamation-triangle"></i> Grammar Analysis</h5>
                    <p id="grammarSummary" class="mb-3">Loading grammar analysis...</p>

                    <h6>Common Errors Found:</h6>
                    <ul id="commonErrors" class="mb-4">
                        <li>Loading...</li>
                    </ul>

                    <h6>Specific Corrections:</h6>
                    <div id="grammarCorrections">
                        <div class="grammar-correction">
                            <p>Loading corrections...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Style Tab -->
            <div id="styleTab" class="tab-content">
                <div class="feedback-section">
                    <h5><i class="bi bi-brush"></i> Writing Style Analysis</h5>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Tone:</h6>
                            <p id="writingTone">Analyzing tone...</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Vocabulary Level:</h6>
                            <p id="vocabularyLevel">Analyzing vocabulary...</p>
                        </div>
                    </div>

                    <h6><i class="bi bi-star"></i> Strengths:</h6>
                    <ul id="styleStrengths" class="text-success mb-4">
                        <li>Loading...</li>
                    </ul>

                    <h6><i class="bi bi-pencil"></i> Style Suggestions:</h6>
                    <div id="styleSuggestions">
                        <p>Loading suggestions...</p>
                    </div>
                </div>
            </div>

            <!-- Sentences Tab -->
            <div id="sentencesTab" class="tab-content">
                <div class="feedback-section">
                    <h5><i class="bi bi-list-ol"></i> Sentence-by-Sentence Analysis</h5>
                    <p class="text-muted mb-4">Each sentence is analyzed for clarity, effectiveness, and potential improvements.</p>

                    <div id="sentenceAnalysisList">
                        <div class="sentence-analysis-item">
                            <p>Loading sentence analysis...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="continueWritingBtn" class="btn btn-primary me-2">
                    <i class="bi bi-pencil"></i> Continue Writing
                </button>
                <button id="newTaskBtn" class="btn btn-outline-success me-2">
                    <i class="bi bi-plus-circle"></i> New Writing Task
                </button>
                <button id="homeBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-house"></i> Back to Home
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Writing prompts for each topic
        const writingPrompts = {
            argumentative: {
                title: 'Argumentative Essay',
                prompts: [
                    'Should social media platforms be regulated by governments? Present your arguments with clear evidence and address counterarguments.',
                    'Is online education as effective as traditional classroom learning? Support your position with specific examples.',
                    'Should artificial intelligence be regulated? Discuss the benefits and risks.'
                ]
            },
            descriptive: {
                title: 'Descriptive Writing',
                prompts: [
                    'Describe your ideal study environment in vivid detail. Use sensory language to bring the scene to life.',
                    'Paint a picture of a memorable place from your childhood. Focus on specific details that make it unique.',
                    'Describe a cultural festival or celebration from your hometown using rich, descriptive language.'
                ]
            },
            narrative: {
                title: 'Narrative Essay',
                prompts: [
                    'Tell the story of a time when you had to overcome a significant challenge. Include dialogue and specific details.',
                    'Narrate an experience that changed your perspective on life. Build tension and include a clear resolution.',
                    'Write about a memorable journey or trip. Focus on the narrative arc and character development.'
                ]
            },
            analytical: {
                title: 'Analytical Writing',
                prompts: [
                    'Analyze the impact of technology on modern communication. Break down the topic into key components.',
                    'Examine the causes and effects of climate change. Use evidence to support your analysis.',
                    'Analyze a piece of literature or film that influenced you. Discuss themes, techniques, and impact.'
                ]
            },
            academic: {
                title: 'Academic Writing',
                prompts: [
                    'Discuss the role of education in economic development. Use formal academic language and cite examples.',
                    'Examine the ethical implications of genetic engineering. Present multiple perspectives with scholarly tone.',
                    'Analyze the impact of globalization on local cultures. Use academic structure and formal citations.'
                ]
            },
            business: {
                title: 'Business Writing',
                prompts: [
                    'Write a proposal for implementing a new sustainability initiative in a company.',
                    'Draft a professional email requesting a meeting with a potential client or investor.',
                    'Create a brief report analyzing market trends in your industry of interest.'
                ]
            }
        };

        // Current state
        let currentTopic = null;
        let currentPrompt = null;
        let currentAnalysis = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateStats();
        });

        // Set up all event listeners
        function setupEventListeners() {
            // Topic card clicks
            document.querySelectorAll('.topic-card').forEach(card => {
                card.addEventListener('click', function() {
                    const topic = this.dataset.topic;
                    selectTopic(topic);
                });
            });

            // Writing editor input
            const editor = document.getElementById('writingEditor');
            if (editor) {
                editor.addEventListener('input', updateStats);
            }

            // Tab clicks
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Button clicks
            document.getElementById('backToTopicsBtn')?.addEventListener('click', backToTopics);
            document.getElementById('analyzeBtn')?.addEventListener('click', analyzeWriting);
            document.getElementById('clearBtn')?.addEventListener('click', clearEditor);
            document.getElementById('continueWritingBtn')?.addEventListener('click', continueWriting);
            document.getElementById('newTaskBtn')?.addEventListener('click', newTask);
            document.getElementById('homeBtn')?.addEventListener('click', goHome);
        }

        // Select a writing topic
        function selectTopic(topic) {
            currentTopic = topic;

            // Update UI to show selected topic
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`[data-topic="${topic}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Get random prompt for this topic
            const topicData = writingPrompts[topic];
            if (topicData) {
                const randomIndex = Math.floor(Math.random() * topicData.prompts.length);
                currentPrompt = topicData.prompts[randomIndex];

                // Update writing area
                document.getElementById('topicTitle').innerHTML =
                    `<i class="bi bi-pencil-square"></i> ${topicData.title}`;
                document.getElementById('writingPrompt').textContent = currentPrompt;

                // Show writing area, hide topic selector
                document.getElementById('topicSelector').style.display = 'none';
                document.getElementById('writingArea').classList.add('active');
            }
        }

        // Update writing statistics
        function updateStats() {
            const text = document.getElementById('writingEditor').value;

            // Calculate stats
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            const sentences = text.trim() ? (text.match(/[.!?]+/g) || []).length : 0;
            const paragraphs = text.trim() ? text.split(/\n\s*\n/).filter(p => p.trim()).length : 0;
            const readingTime = Math.ceil(words / 200); // 200 words per minute

            // Update display
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
            document.getElementById('sentenceCount').textContent = sentences;
            document.getElementById('paragraphCount').textContent = paragraphs;
            document.getElementById('readingTime').textContent = `${readingTime}m`;
        }

        // Analyze writing with GPT
        async function analyzeWriting() {
            const text = document.getElementById('writingEditor').value.trim();

            if (!text) {
                alert('Please write something before analyzing.');
                return;
            }

            if (text.split(/\s+/).length < 50) {
                alert('Please write at least 50 words for meaningful analysis.');
                return;
            }

            // Show loading state
            document.getElementById('loadingState').classList.add('active');
            document.getElementById('analyzeBtn').disabled = true;

            try {
                // Check for auth token
                const token = localStorage.getItem('auth_token');

                if (!token) {
                    // Provide basic analysis without login
                    performBasicAnalysis(text);
                    return;
                }


                // Call API for GPT analysis
                const response = await fetch('/api/writing/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        text: text,
                        topic: currentTopic || 'general',
                        prompt: currentPrompt || 'General writing task'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);

                    // Fallback to basic analysis
                    performBasicAnalysis(text);
                    return;
                }

                const data = await response.json();

                if (data.success && data.analysis) {
                    currentAnalysis = data.analysis;
                    displayComprehensiveAnalysis(data.analysis);
                } else {
                    performBasicAnalysis(text);
                }

            } catch (error) {
                console.error('Analysis error:', error);
                // Fallback to basic analysis instead of showing error
                performBasicAnalysis(text);
            } finally {
                document.getElementById('loadingState').classList.remove('active');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // Perform basic client-side analysis when GPT is not available
        function performBasicAnalysis(text) {
            const words = text.trim().split(/\s+/).length;
            const sentences = (text.match(/[.!?]+/g) || []).length;
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim()).length;

            // Calculate basic scores
            const avgWordsPerSentence = sentences > 0 ? Math.round(words / sentences) : 0;
            const readabilityScore = Math.min(100, Math.max(60, 100 - Math.abs(avgWordsPerSentence - 15) * 2));
            const structureScore = paragraphs >= 3 ? 85 : 70;

            // Create a basic analysis object that matches GPT structure
            const analysis = {
                overall_analysis: {
                    score: Math.round((readabilityScore + structureScore) / 2),
                    summary: `Your essay contains ${words} words in ${sentences} sentences across ${paragraphs} paragraph(s).`,
                    on_topic: true,
                    on_topic_explanation: 'Unable to verify topic relevance without AI analysis. Please login for full analysis.',
                    main_points: ['Login to identify main points'],
                    thesis_statement: 'Login to identify thesis statement',
                    conclusion_quality: 'Login for conclusion analysis'
                },
                grammar_analysis: {
                    score: 75,
                    summary: 'Grammar analysis requires AI. Please login for detailed grammar checking.',
                    common_errors: ['Login for grammar analysis'],
                    specific_corrections: []
                },
                style_analysis: {
                    score: readabilityScore,
                    tone: 'Login for tone analysis',
                    vocabulary_level: 'Login for vocabulary analysis',
                    strengths: [
                        words >= 250 ? 'Good essay length' : null,
                        paragraphs >= 3 ? 'Well-structured paragraphs' : null
                    ].filter(Boolean),
                    suggestions: [
                        {
                            issue: 'AI Analysis Not Available',
                            example: 'Please login to receive detailed style suggestions',
                            improvement: 'Login to access AI-powered writing analysis'
                        }
                    ]
                },
                sentence_by_sentence: [
                    {
                        sentence_number: 1,
                        original: 'Sentence-by-sentence analysis requires AI',
                        analysis: {
                            clarity: 'Login required',
                            effectiveness: 'Login required',
                            issues: ['Login for detailed analysis'],
                            suggestions: 'Please login to receive sentence-level feedback'
                        }
                    }
                ],
                recommendations: {
                    top_priorities: [
                        'Login to receive personalized recommendations',
                        words < 250 ? 'Expand your essay to at least 250 words' : 'Continue developing your ideas',
                        paragraphs < 3 ? 'Organize your essay into multiple paragraphs' : 'Good paragraph structure'
                    ],
                    next_steps: 'For comprehensive AI-powered analysis including grammar checking, style suggestions, and sentence-by-sentence feedback, please login to your account.'
                }
            };

            displayComprehensiveAnalysis(analysis);
        }

        // Display comprehensive GPT analysis
        function displayComprehensiveAnalysis(analysis) {
            // Check if analysis has the expected structure
            if (!analysis || typeof analysis !== 'object') {
                console.error('Invalid analysis object:', analysis);
                // Use fallback analysis instead of showing error
                performBasicAnalysis(document.getElementById('writingEditor').value.trim());
                return;
            }

            // If GPT didn't return the expected structure, create a fallback
            if (!analysis.overall_analysis && !analysis.grammar_analysis && !analysis.style_analysis) {

                // If analysis is just a string or has content key, extract it
                let content = '';
                if (typeof analysis === 'string') {
                    content = analysis;
                } else if (analysis.content) {
                    content = analysis.content;
                } else {
                    content = JSON.stringify(analysis);
                }

                // Create a basic analysis with GPT content
                const text = document.getElementById('writingEditor').value.trim();
                const words = text.split(/\s+/).length;
                const sentences = (text.match(/[.!?]+/g) || []).length;

                analysis = {
                    overall_analysis: {
                        score: 80,
                        summary: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
                        on_topic: true,
                        on_topic_explanation: 'AI provided general feedback on your writing.',
                        main_points: ['Check the full feedback below for details'],
                        thesis_statement: 'Please see detailed analysis'
                    },
                    grammar_analysis: {
                        score: 75,
                        summary: 'GPT provided general writing feedback.',
                        common_errors: ['See detailed analysis'],
                        specific_corrections: []
                    },
                    style_analysis: {
                        score: 78,
                        tone: 'Appropriate',
                        vocabulary_level: 'Good',
                        strengths: ['Clear writing'],
                        suggestions: [{
                            issue: 'Full GPT Response',
                            example: content,
                            improvement: 'Review the complete feedback for specific suggestions'
                        }]
                    },
                    sentence_by_sentence: [],
                    recommendations: {
                        top_priorities: ['Review detailed feedback', 'Continue practicing'],
                        next_steps: 'Use the feedback provided to improve your writing'
                    }
                };

            }

            // Overall Tab
            if (analysis.overall_analysis) {
                const overall = analysis.overall_analysis;

                // Scores - with null checks
                const overallScoreEl = document.getElementById('overallScore');
                if (overallScoreEl) {
                    overallScoreEl.textContent = overall.score || '75';
                }

                // Topic relevance badge
                const topicBadge = document.getElementById('topicRelevance');
                if (topicBadge) {
                    if (overall.on_topic) {
                        topicBadge.className = 'on-topic-badge on-topic';
                        topicBadge.innerHTML = '<i class="bi bi-check-circle"></i> On Topic';
                    } else {
                        topicBadge.className = 'on-topic-badge off-topic';
                        topicBadge.innerHTML = '<i class="bi bi-x-circle"></i> Off Topic';
                    }
                }

                // Summary
                document.getElementById('essaySummary').innerHTML = `
                    <p>${overall.summary || 'Your essay presents interesting ideas.'}</p>
                    <p><strong>Topic Relevance:</strong> ${overall.on_topic_explanation || 'Essay addresses the prompt.'}</p>
                `;

                // Main points
                const mainPointsList = document.getElementById('mainPoints');
                mainPointsList.innerHTML = (overall.main_points || []).map(point =>
                    `<li>${point}</li>`
                ).join('') || '<li>No main points identified</li>';

                // Thesis
                document.getElementById('thesisStatement').innerHTML = `
                    <strong>Identified Thesis:</strong> ${overall.thesis_statement || 'No clear thesis found'}
                `;

                // Conclusion quality
                if (overall.conclusion_quality) {
                    document.getElementById('essaySummary').innerHTML += `
                        <p><strong>Conclusion:</strong> ${overall.conclusion_quality}</p>
                    `;
                }
            }

            // Grammar Tab
            if (analysis.grammar_analysis) {
                const grammar = analysis.grammar_analysis;

                document.getElementById('grammarScore').textContent = grammar.score || '75';
                document.getElementById('grammarSummary').textContent =
                    grammar.summary || 'Your grammar needs review.';

                // Common errors
                const errorsList = document.getElementById('commonErrors');
                errorsList.innerHTML = (grammar.common_errors || []).map(error =>
                    `<li>${error}</li>`
                ).join('') || '<li>No recurring errors found</li>';

                // Specific corrections
                const correctionsDiv = document.getElementById('grammarCorrections');
                correctionsDiv.innerHTML = (grammar.specific_corrections || []).map(corr => `
                    <div class="grammar-correction">
                        <h6><span class="tag-grammar">${corr.type || 'Error'}</span></h6>
                        <p><strong>Original:</strong> "${corr.original}"</p>
                        <p><strong>Correction:</strong> <span class="text-success">"${corr.correction}"</span></p>
                        <p><em>${corr.explanation || ''}</em></p>
                    </div>
                `).join('') || '<p>No specific grammar corrections needed.</p>';
            }

            // Style Tab
            if (analysis.style_analysis) {
                const style = analysis.style_analysis;

                document.getElementById('styleScore').textContent = style.score || '75';
                document.getElementById('writingTone').textContent = style.tone || 'Not analyzed';
                document.getElementById('vocabularyLevel').textContent =
                    style.vocabulary_level || 'Intermediate';

                // Strengths
                const strengthsList = document.getElementById('styleStrengths');
                strengthsList.innerHTML = (style.strengths || []).map(strength =>
                    `<li>${strength}</li>`
                ).join('') || '<li>Keep practicing to develop strengths</li>';

                // Suggestions
                const suggestionsDiv = document.getElementById('styleSuggestions');
                suggestionsDiv.innerHTML = (style.suggestions || []).map(sugg => `
                    <div class="mb-3 p-3 border-start border-4 border-info">
                        <h6>${sugg.issue}</h6>
                        <p class="mb-1"><strong>Example:</strong> ${sugg.example || ''}</p>
                        <p class="text-primary"><strong>Improvement:</strong> ${sugg.improvement}</p>
                    </div>
                `).join('') || '<p>Your writing style is appropriate.</p>';
            }

            // Sentence-by-Sentence Analysis
            if (analysis.sentence_by_sentence && analysis.sentence_by_sentence.length > 0) {
                const sentenceList = document.getElementById('sentenceAnalysisList');
                sentenceList.innerHTML = analysis.sentence_by_sentence.map((sent, idx) => `
                    <div class="sentence-analysis-item">
                        <div>
                            <span class="sentence-number">${sent.sentence_number || idx + 1}</span>
                            <strong>Sentence ${sent.sentence_number || idx + 1}</strong>
                        </div>

                        <div class="sentence-original">
                            "${sent.original}"
                        </div>

                        ${sent.analysis ? `
                            <div class="mt-3">
                                <p><strong>Clarity:</strong> ${sent.analysis.clarity || 'Not analyzed'} |
                                   <strong>Effectiveness:</strong> ${sent.analysis.effectiveness || 'Not analyzed'}</p>

                                ${sent.analysis.issues && sent.analysis.issues.length > 0 ? `
                                    <p><strong>Issues:</strong></p>
                                    <div class="mb-2">
                                        ${sent.analysis.issues.map(issue =>
                                            `<span class="issue-tag tag-${issue.includes('grammar') ? 'grammar' :
                                                issue.includes('clarity') ? 'clarity' : 'style'}">${issue}</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}

                                ${sent.analysis.suggestions ? `
                                    <p><strong>Suggestions:</strong> ${sent.analysis.suggestions}</p>
                                ` : ''}

                                ${sent.analysis.alternative ? `
                                    <div class="sentence-alternative">
                                        <strong>Alternative:</strong> "${sent.analysis.alternative}"
                                    </div>
                                ` : ''}
                            </div>
                        ` : '<p class="text-muted">No specific analysis for this sentence.</p>'}
                    </div>
                `).join('');
            }

            // Recommendations
            if (analysis.recommendations) {
                const recList = document.getElementById('recommendations');
                recList.innerHTML = (analysis.recommendations.top_priorities || []).map(rec =>
                    `<li>${rec}</li>`
                ).join('') || '<li>Continue practicing your writing skills</li>';

                if (analysis.recommendations.next_steps) {
                    document.getElementById('essaySummary').innerHTML += `
                        <div class="alert alert-info mt-3">
                            <strong>Next Steps:</strong> ${analysis.recommendations.next_steps}
                        </div>
                    `;
                }
            }

            // Show analysis section, hide writing area
            document.getElementById('writingArea').classList.remove('active');
            document.getElementById('analysisSection').classList.add('active');
        }

        // Switch analysis tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab')?.classList.add('active');
        }

        // Navigation functions
        function backToTopics() {
            document.getElementById('writingArea').classList.remove('active');
            document.getElementById('analysisSection').classList.remove('active');
            document.getElementById('topicSelector').style.display = 'block';

            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function clearEditor() {
            if (confirm('Are you sure you want to clear your writing?')) {
                document.getElementById('writingEditor').value = '';
                updateStats();
            }
        }

        function continueWriting() {
            document.getElementById('analysisSection').classList.remove('active');
            document.getElementById('writingArea').classList.add('active');
        }

        function newTask() {
            if (confirm('Start a new writing task? Your current work will be lost.')) {
                document.getElementById('writingEditor').value = '';
                updateStats();
                backToTopics();
            }
        }

        function goHome() {
            window.location.href = '/';
        }
    </script>
</body>
</html>